<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI Photo Station V1418 - Feature Complete</title>
    <style>
        :root { --bg: #0b0e14; --card: #161b22; --input: #0d1117; --text: #c9d1d9; --secondary: #58a6ff; --accent: #ff7b72; --success: #238636; --warning: #d29922; --tab-active: #1f6feb; }
        body { font-family: "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1200px; margin: 0 auto; line-height: 1.5; }
        .section { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; }
        .row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: flex-end; }
        .col { flex: 1; min-width: 200px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 13px; color: #8b949e; }
        select, input[type="text"], input[type="password"], input[type="number"], textarea { width: 100%; padding: 10px; background: var(--input); border: 1px solid #30363d; color: #fff; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        
        .btn { padding: 12px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px; white-space: nowrap; }
        .btn-gen { background: var(--success); color: white; width: 100%; }
        .btn-api { background: var(--secondary); color: white; width: 100%; }
        .btn-scan { background: var(--warning); color: #000; }
        .btn-tool { background: #30363d; color: white; }
        .btn-save { background: #238636; color: white; }
        .btn-del { background: #da3633; color: white; }

        .tab-header { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        .tab-btn { background: #21262d; color: #8b949e; flex: 1; padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px solid transparent; font-weight: bold; }
        .tab-btn.active { background: var(--tab-active); color: white; border-color: var(--secondary); }
        .tab-btn:hover { background: #30363d; }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Sub Panels for Lighting/Theme */
        .sub-panel { background: #0d1117; padding: 15px; border-radius: 8px; border-left: 3px solid var(--secondary); margin-top: 10px; display: none; }
        .color-item { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 8px; }
        .color-swatch { width: 18px; height: 18px; border-radius: 3px; border: 1px solid #8b949e; }

        /* Dynamic Lists & Effects */
        .dynamic-item { background: #1c2128; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #30363d; position: relative; }
        .btn-remove { position:absolute; right:10px; top:10px; background:none; border:none; color:var(--accent); cursor:pointer; font-weight:bold; }
        
        .preset-box { border: 1px dashed var(--secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px; background: rgba(88, 166, 255, 0.1); }
        .help-text { font-size: 12px; color: #8b949e; margin-top: 5px; line-height: 1.4; }
        
        /* Effects Grid */
        .effects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; margin-top: 10px; }
        .effect-item { background: #21262d; padding: 8px; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 13px; border: 1px solid #30363d; cursor: pointer; }
        .effect-item:hover { border-color: var(--secondary); }

        pre { background: #010409; padding: 20px; border-radius: 8px; color: #7ee787; border: 1px solid #30363d; white-space: pre-wrap; font-family: 'Consolas', monospace; min-height: 150px; font-size: 13px; }
        .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:5px; background: #8b949e; }
        .status-ok { background: var(--success); box-shadow: 0 0 5px var(--success); }
    </style>
</head>
<body onload="init()">

    <div class="section" style="border: 1px solid var(--secondary);">
        <label>ğŸ”‘ API é‡‘é‘°ç®¡ç† (Saved Keys)</label>
        <div class="row">
            <div class="col" style="flex:1;">
                <select id="savedKeys" onchange="loadSelectedKey()">
                    <option value="">-- é¸æ“‡å·²å­˜çš„é‡‘é‘° --</option>
                </select>
            </div>
            <div class="col" style="flex:2;">
                <input type="password" id="apiKey" placeholder="è¼¸å…¥ Google AI Studio Key (AIza...)">
            </div>
            <div class="col" style="flex:1;">
                <input type="text" id="keyName" placeholder="çµ¦é€™å€‹ Key ä¸€å€‹åç¨±">
            </div>
            <div class="col" style="flex:0.5;">
                <button class="btn btn-save" onclick="saveKey()">ğŸ’¾ å„²å­˜</button>
            </div>
            <div class="col" style="flex:0.5;">
                <button class="btn btn-del" onclick="deleteKey()">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>
        </div>
        
        <div class="row">
             <div class="col" style="flex:0.8;">
                 <button class="btn btn-scan" onclick="scanModels()">ğŸ” 1. æƒæå¯ç”¨æ¨¡å‹</button>
            </div>
            <div class="col" style="flex:1.5;">
                <select id="apiModel"><option value="">è«‹å…ˆæƒæ...</option></select>
            </div>
        </div>
        <div id="statusMsg" style="font-size:12px; color:#8b949e; margin-top:5px;"><span class="status-dot" id="statusDot"></span> å°±ç·’</div>
    </div>

    <div class="tab-header">
        <div class="tab-btn active" onclick="switchTab('gen')" id="btn-gen">ğŸ¨ ç”Ÿåœ–æ¨¡å¼ (Generate)</div>
        <div class="tab-btn" onclick="switchTab('edit')" id="btn-edit">ğŸ› ï¸ æ”¹åœ–æ¨¡å¼ (Edit)</div>
    </div>

    <div id="tab-gen" class="tab-content active">
        <div class="section">
            <label style="color: var(--secondary);"><input type="checkbox" id="isPhotogenic" checked> âœ¨ Photogenic Mode (å–æ™¯ç¾å­¸èˆ‡è‚¢é«”å‹•æ…‹æ ¡æ­£)</label>
            <div class="row" style="margin-top:15px;">
                <div class="col"><label>å°ˆæ¡ˆåç¨±</label><input type="text" id="pName" value="New_Project"></div>
                <div class="col">
                    <label>è¦–è¦ºé¢¨æ ¼</label>
                    <select id="pStyle">
                        <option value="Hyper-Realistic Portraiture (PBR)">è¶…å¯«å¯¦äººåƒ (PBR)</option>
                        <option value="High-end Editorial Fashion Photography">é«˜ç«¯é›œèªŒ (Editorial)</option>
                        <option value="Cinematic Movie Still">é›»å½±åŠ‡ç…§ (Cinematic)</option>
                        <option value="Candid Smartphone Photo">æ‰‹æ©ŸæŠ“æ‹ (Smartphone)</option>
                        <option value="Analog Film, Kodak Portra 400">åº•ç‰‡è³ªæ„Ÿ (Analog Film)</option>
                        <option value="DSLR Raw Output, neutral color">æ•¸ä½å–®åç›´å‡º (DSLR Raw)</option>
                        <option value="Film Noir aesthetic, high contrast monochrome">é»‘ç™½é›»å½±æ„Ÿ (Noir)</option>
                        <option value="Cinematic Warm-Gray tone, muted colors">æš–ç°é›»å½±æ„Ÿ (Cinematic Warm-Gray)</option>
                    </select>
                </div>
            </div>
       
            <div class="row">
                <div class="col"><label>ä¸»é¡Œæå¯« (Subject)</label><input type="text" id="pSubject" placeholder="äººç‰©ã€å¤–è§€ã€ç‹€æ…‹æè¿°"></div>
                <div class="col"><label>æƒ…å¢ƒç’°å¢ƒ (Context)</label><input type="text" id="pContext" placeholder="å ´æ™¯ã€ç’°å¢ƒã€æ™‚é–“ã€æ°›åœ"></div>
            </div>

            <div class="row">
                <div class="col"><label>é¡é ­è¦–è§’ (Angle)</label>
                    <select id="pAngle">
                        <option value="Eye Level">å¹³è¦– (Eye Level)</option>
                        <option value="Low Angle">ä»°æ‹ (Low Angle)</option>
                        <option value="High Angle">ä¿¯æ‹ (High Angle)</option>
                        <option value="Side View">å´é¢ (Side View)</option>
                        <option value="Over The Shoulder">éè‚©é¡é ­ (Over The Shoulder)</option>
                        <option value="Dutch Angle">å‚¾æ–œè¦–è§’ (Dutch Angle)</option>
                        <option value="Drone View">ç„¡äººæ©Ÿè¦–è§’ (Drone View)</option>
                    </select>
                </div>
                <div class="col"><label>é¡é ­æ™¯åˆ¥ / é¡é ­</label>
                    <select id="pShot" onchange="checkCloseup()">
                        <option value="Full body shot / 35mm Wide">å…¨èº« (Full Body) / 35mm å»£è§’</option>
                        <option value="Upper body shot (Half body) / 50mm Standard">åŠèº« (Half Body) / 50mm æ¨™æº–</option>
                        <option value="Cowboy shot / 50mm Standard">ä¸ƒåˆ†èº« (Cowboy Shot) / 50mm æ¨™æº–</option>
                        <option value="Close-up shot / 85mm Portrait">ç‰¹å¯« (Close-up) / 85mm äººåƒé¡</option>
                        <option value="Extreme close-up / Macro">æ¥µè‡´ç‰¹å¯« (Extreme CU) / å¾®è·é¡</option>
                    </select>
                </div>
                <div class="col" id="closeupBox" style="display:none;"><label style="color:var(--accent)">ç‰¹å¯«éƒ¨ä½ (Focus Area)</label>
                    <select id="pCloseupOther" onchange="document.getElementById('customFocus').style.display = (this.value==='Custom')?'block':'none';">
                        <option value="Eyes">çœ¼ç› (Eyes)</option>
                        <option value="Lips">å˜´å”‡ (Lips)</option>
                        <option value="Face details">è‡‰éƒ¨ç´°ç¯€ (Skin / Texture)</option>
                        <option value="Hands">æ‰‹éƒ¨ (Hands)</option>
                        <option value="Jewelry / Accessories">é£¾å“ / é…ä»¶</option>
                        <option value="Fabric texture">å¸ƒæ–™ç´‹ç† (Fabric)</option>
                        <option value="Sweat / Skin pores">æ±—æ°´ / æ¯›å­”ç´°ç¯€</option>
                        <option value="Custom">è‡ªè¨‚æè¿°â€¦</option>
                    </select>
                    <input type="text" id="customFocus" style="display:none; margin-top:8px;" placeholder="è«‹è¼¸å…¥è‡ªè¨‚ç‰¹å¯«éƒ¨ä½æè¿°">
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>å…‰ç·šè¨­å®š (Lighting)</label>
                    <select id="pLight" onchange="updateLightPanel()">
                        <option value="">-- æœªæŒ‡å®š --</option>
                        </select>
                    <div id="lightPanel" class="sub-panel">
                        <div class="row">
                            <div class="col"><label>è§’åº¦</label><input type="text" id="lAngle"></div>
                            <div class="col"><label>å¯¬åº¦</label><input type="text" id="lWidth"></div>
                            <div class="col"><label>å°æ¯”åº¦</label><select id="lContrast"></select></div>
                        </div>
                        <div class="col" style="margin-top:10px;"><label>ä¸»é«”è½é» (Target Area)</label>
                            <select id="lTarget">
                                <option value="Unspecified">æœªæŒ‡å®š</option>
                                <option value="Across eyes and bridge of nose">çœ¼é¼»éƒ¨</option>
                                <option value="Side of face and neck">å´è‡‰èˆ‡é ¸éƒ¨</option>
                                <option value="Behind head">è…¦å¾ŒèƒŒæ™¯</option>
                                <option value="Evenly on face">å…¨è‡‰å‡å‹»è¦†è“‹</option>
                                <option value="Shoulders and chest">è‚©è†€èˆ‡èƒ¸å£</option>
                                <option value="Center of face">è‡‰éƒ¨ä¸­å¿ƒ</option>
                                <option value="Background behind head">èƒŒæ™¯ï¼šé ­éƒ¨å¾Œæ–¹</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <label>ä¸»é¡Œè‰²å½©</label>
                    <select id="pTheme" onchange="updateThemePanel()">
                        <option value="">-- æœªæŒ‡å®š --</option>
                        <option value="Noir">åˆå¤œé›»å½± (Noir)</option>
                        <option value="Executive">å•†å‹™ç²¾è‹± (Executive)</option>
                        <option value="Modern Tech">éƒ½æœƒç§‘æŠ€ (Modern Tech)</option>
                        <option value="Vintage Film">å¾©å¤è† æ² (Vintage Film)</option>
                        <option value="Prism">è™¹å…‰æŠ˜å°„ (Prism)</option>
                        <option value="Custom">è‡ªæŒ‡å®š...</option>
                    </select>
                    <div id="themePanel" class="sub-panel">
                        <div class="color-item"><div id="swatch-h" class="color-swatch"></div> <label style="width:60px;">ä¸»è‰²(äº®)</label><input type="text" id="tHighlight" oninput="syncSwatch('h')"></div>
                        <div class="color-item"><div id="swatch-s" class="color-swatch"></div> <label style="width:60px;">æ¬¡è‰²(æš—)</label><input type="text" id="tShadow" oninput="syncSwatch('s')"></div>
                        <div class="color-item"><div id="swatch-a" class="color-swatch"></div> <label style="width:60px;">å¼·èª¿è‰²</label><input type="text" id="tAccent" oninput="syncSwatch('a')"></div>
                        <label>è‰²æº«/èª¿æ€§</label>
                        <select id="tTone">
                            <option value="35Â° ~ 50Â° Warm">35Â° ~ 50Â° Warm</option>
                            <option value="Neutral">Neutral</option>
                            <option value="6500K Cool">6500K Cool</option>
                            <option value="Low Saturation">Low Saturation</option>
                            <option value="Dynamic">Dynamic</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>è¡¨æƒ… (Expression)</label>
                    <select id="pExpression">
                        <option value="">-- æœªæŒ‡å®š --</option>
                        <option value="Confident warm smile, showing teeth">è‡ªä¿¡éœ²é½’å¾®ç¬‘ (Confident warm smile)</option>
                        <option value="Gentle closed-lip smile">æº«æŸ”å¾®ç¬‘ (Gentle closed-lip)</option>
                        <option value="Confident smirk">è‡ªä¿¡æ­ªå˜´ç¬‘ (Confident smirk)</option>
                        <option value="Sexy and alluring expression, bedroom eyes">æ€§æ„Ÿèª˜äºº (Sexy, bedroom eyes)</option>
                        <option value="Neutral, relaxed">æ”¾é¬†ä¸­æ€§ (Neutral, relaxed)</option>
                        <option value="Intense gaze">å†·å³»å‡è¦– (Intense gaze)</option>
                    </select>
                </div>
                <div class="col">
                    <label>æƒ…å¢ƒæ°›åœ (Mood)</label>
                    <select id="pMood">
                        <option value="">-- æœªæŒ‡å®š --</option>
                        <option value="Introspective (Poetic, Calm)">æ²ˆéœå…§çœ (Introspective)</option>
                        <option value="Fashion Editorial (Bold, Vogue)">æ™‚å°šç¤¾è«– (Fashion Editorial)</option>
                        <option value="Executive Aura (Refined, Modern)">å•†å‹™ç¾å­¸ (Executive Aura)</option>
                        <option value="Moody Noir (Mysterious)">ç¥ç¥•æ†‚é¬± (Moody Noir)</option>
                        <option value="Urban Lifestyle (Casual Elegance)">éƒ½æœƒä¼‘é–’ (Urban Lifestyle)</option>
                    </select>
                </div>
            </div>

            <div class="section" style="padding: 15px; margin-bottom: 15px; border-color: #30363d;">
                <label>ç‰¹æ®Šæ•ˆæœ (Special Effects)</label>
                <div class="effects-grid">
                    <label class="effect-item" title="æ¨¡æ“¬çœŸå¯¦å…‰ç·šåœ¨ç‰©é«”é–“çš„æŠ˜å°„èˆ‡åå°„ï¼Œå¤§å¹…å¢åŠ çœŸå¯¦æ„Ÿ">
                        <input type="checkbox" class="effect-check" value="Ray Tracing Reflections"> 
                        å…‰ç·šè¿½è¹¤åå°„ (Ray Tracing) <br><span style="font-size:11px; color:#8b949e; margin-left:5px;">(æ¨¡æ“¬çœŸå¯¦ç‰©ç†åå…‰èˆ‡æŠ˜å°„)</span>
                    </label>
                    <label class="effect-item"><input type="checkbox" class="effect-check" value="Realistic Sweat Sheen"> çœŸå¯¦æ±—æ°´å…‰æ¾¤ (Realistic Sweat Sheen)</label>
                    <label class="effect-item"><input type="checkbox" class="effect-check" value="Subtle Film Grain (3%)"> å¾®é¡†ç²’æ„Ÿ (Subtle Film Grain 3%)</label>
                    <label class="effect-item"><input type="checkbox" class="effect-check" value="Prism Flare"> ç¨œé¡å…‰æ–‘ (Prism Flare)</label>
                    </div>
                <div class="help-text" style="margin-top:5px; color:#58a6ff;">* ç³»çµ±å·²é è¨­ï¼šé«˜éšè‚Œè†šç‰©ç† (SSS)ã€8K è§£æåº¦ã€ç„¡ç£¨çš®è™•ç†ã€‚</div>
            </div>

            <div class="section" style="margin-bottom:0; padding-bottom:10px;">
                <h3>å¤šé‡åƒè€ƒåœ–çŸ©é™£</h3>
                <div id="refList"></div>
                <button class="btn btn-tool" onclick="addRef()">+ æ–°å¢åƒè€ƒåœ–</button>
            </div>
            
             <div class="section" style="margin-top: 20px;">
                <label>ğŸš« è² é¢æç¤ºè© (Negative)</label>
                <textarea id="pNeg" style="height: 50px;">Modified jawline, Crow's feet, Aged skin, Smooth plastic skin, CGI, Cartoonish, Blurry face, Distorted anatomy.</textarea>
            </div>
        </div>
    </div>

    <div id="tab-edit" class="tab-content">
        <div class="section">
            <div class="row">
                <div class="col"><label>æ”¹åœ–å°ˆæ¡ˆåç¨±</label><input type="text" id="eName" value="Edit_Project"></div>
            </div>
            
            <div class="preset-box">
                <label style="color:var(--secondary)">ğŸ¤– èƒŒæ™¯ç½®æ›/ç©ºé–“é‡æ§‹ç²¾éˆ (Spatial Logic Wizard)</label>
                <div class="row">
                     <div class="col" style="flex:0.2;">
                        <input type="checkbox" id="useBgPreset" onchange="toggleBgPreset()" style="width:20px; height:20px;">
                    </div>
                    <div class="col" style="flex:2;">
                        <input type="text" id="bgRefId" placeholder="åƒè€ƒåœ–ID (ä¾‹å¦‚: Scene_Rome)" disabled>
                    </div>
                    <div class="col" style="flex:2;">
                        <select id="bgLightOpt" disabled>
                            <option value="Keep Original Lighting">ä¿ç•™åŸåœ–å…‰ç·š (Keep Original Lighting)</option>
                            <option value="Match Reference Lighting">åŒ¹é…åƒè€ƒåœ–å…‰ç·š (Match Reference Lighting)</option>
                        </select>
                    </div>
                    </div>
                <div class="help-text">* å‹¾é¸ä¸¦å¡«å…¥IDå¾Œï¼Œ<b>ç³»çµ±å°‡åœ¨ç”Ÿæˆæ™‚è‡ªå‹•æ³¨å…¥</b>ã€Œäººç‰©ä¿ç•™ã€èˆ‡ã€Œå ´æ™¯é‡æ§‹ã€é‚è¼¯ï¼Œç„¡éœ€æ‰‹å‹•æ“ä½œã€‚</div>
            </div>

            <div class="row">
                <div class="col">
                    <label>æ•´é«”æ”¹åœ–æŒ‡ä»¤ (Instruction)</label>
                    <textarea id="eInstruction" style="height: 80px;" placeholder="ä¾‹å¦‚ï¼šæ¸…é™¤ä¸»è§’å‰æ–¹çš„æ‰€æœ‰é®è”½ç‰©ï¼Œä¸¦é‡æ–°æ•´ç†ç©ºé–“é‚è¼¯..."></textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>å…·é«”ä¿®æ”¹é …ç›® (Modifications)</h3>
            <div id="modList"></div>
            <button class="btn btn-tool" onclick="addModItem()">+ æ–°å¢ä¿®æ”¹é …</button>
        </div>

        <div class="section">
            <h3>ç©ºé–“é‚è¼¯ (Spatial Logic)</h3>
            <div id="spatialList"></div>
            <button class="btn btn-tool" onclick="addSpatialItem()">+ æ–°å¢ç©ºé–“é‚è¼¯</button>
        </div>

        <div class="section">
            <label>ğŸš« æ”¹åœ–è² é¢æç¤ºè© (Negative Prompt)</label>
            <textarea id="eNeg" style="height: 60px;">leaves covering man, cluttered composition, eye wrinkles, plastic skin</textarea>
        </div>
    </div>

    <div class="row" style="margin-top:20px;">
        <div class="col"><button class="btn btn-gen" onclick="generateLocal()">é è¦½æœ¬åœ° JSON</button></div>
        <div class="col"><button class="btn btn-api" onclick="runAI()">2. å‘¼å« Gemini è½‰è­¯</button></div>
    </div>

    <pre id="output">ç­‰å¾…æŒ‡ä»¤...</pre>
    
    <div style="display:flex; gap:10px;">
        <button class="btn btn-tool" onclick="copyText()">ğŸ“‹ è¤‡è£½</button>
        <button class="btn btn-tool" onclick="saveFile()">ğŸ’¾ å„²å­˜</button>
        <button class="btn btn-tool" onclick="document.getElementById('loadInput').click()">ğŸ“‚ è®€å–</button>
        <input type="file" id="loadInput" class="hidden" style="display:none;" onchange="loadFile(event)">
    </div>

    <script>
        let currentTab = 'gen';
        
        // --- Data Definitions ---
        const THEME_DATA = {
            "Noir": { h: "#F8F4E3", s: "#111016", a: "#FFB000", t: "35Â° ~ 50Â° Warm" },
            "Executive": { h: "#E3D5CA", s: "#1A1A1A", a: "#4B3621", t: "Neutral" },
            "Modern Tech": { h: "#FFFFFF", s: "#001F3F", a: "#C0C0C0", t: "6500K Cool" },
            "Vintage Film": { h: "#C3B091", s: "#2D5A27", a: "#D2691E", t: "Low Saturation" },
            "Prism": { h: "#8E8E8E", s: "#000000", a: "#FF00FF", t: "Dynamic" }
        };

        const LIGHTING_DATA = {
            "narrow_beam": {
                name: "æˆ²åŠ‡çª„å…‰ (Narrow Beam)",
                default_angle: -28, default_width: "15%", contrast_ratio: "7:1",
                default_target: "Unspecified",
                description: "æ©«è·¨çœ¼éƒ¨çš„æ¥µçª„å…‰æ¢ï¼Œç‡Ÿé€ ç¥ç¥•æ„Ÿ"
            },
            "diagonal_sun": {
                name: "å¼·çƒˆæ–œå°„çª—å…‰ (Diagonal Sun)",
                default_angle: -45, default_width: "20%", contrast_ratio: "5:1",
                default_target: "Unspecified",
                description: "æ¨¡æ“¬å¼·çƒˆé™½å…‰é€éçª—æˆ¶çš„æ¢ç‹€é™°å½±"
            },
            "circular_backlight": {
                name: "ç’°ç‹€èƒŒå…‰ (Circular Light)",
                default_angle: 0, default_width: "50%", contrast_ratio: "8:1",
                default_target: "Unspecified",
                description: "èƒŒæ™¯å‡ºç¾å¤§åœ“å½¢å…‰æ–‘ï¼Œå‹¾å‹’è¼ªå»“"
            },
            "geometric_skylight": {
                name: "å¹¾ä½•å¤©çª—æŠ•å½± (Geometric)",
                default_angle: 75, default_width: "30%", contrast_ratio: "6:1",
                default_target: "Unspecified",
                description: "æ–¹æ ¼æˆ–å¡Šç‹€å…‰å½±ï¼Œå…·å‚™å·¥æ¥­/ç§‘æŠ€æ„Ÿ"
            },
            "harsh_flash": {
                name: "ç›´æ¥ç¡¬é–ƒå…‰ (Harsh Flash)",
                default_angle: 0, default_width: "100%", contrast_ratio: "9:1",
                default_target: "Unspecified",
                description: "æ­£é¢å¼·å…‰ï¼Œå¼·èª¿çš®è†šç´‹ç†èˆ‡å¯«å¯¦åº¦"
            },
            "soft_directional": {
                name: "æŸ”å’Œå®šå‘å…‰ (Soft Directional)",
                default_angle: 45, default_width: "60%", contrast_ratio: "2:1",
                default_target: "Unspecified",
                description: "å¹³æ»‘çš„è‡ªç„¶å…‰ï¼Œæ°£æ°›æº«æš–èˆ’é©"
            },
            "golden_hour": {
                name: "é»ƒé‡‘æ™‚åˆ» (Golden Hour)",
                default_angle: null, default_width: null, contrast_ratio: null,
                default_target: "Side of face and hair",
                description: "è‡ªç„¶ç’°å¢ƒå¤•é™½å…‰"
            }
        };

        // --- Init ---
        function init() {
            refreshKeyList();
            populateLightingOptions();
            if(document.getElementById('refList').children.length === 0) addRef("man_face", "Main Identity", 1.0, "25");
            if(document.getElementById('modList').children.length === 0) addModItem("skin_texture", "Remove wrinkles around eyes...");
        }

        // --- Tab Logic ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('btn-' + tab).classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
        }

        // --- API & Model Logic ---
        function refreshKeyList() {
            const saved = JSON.parse(localStorage.getItem('v14_api_keys') || '{}');
            const select = document.getElementById('savedKeys');
            select.innerHTML = '<option value="">-- é¸æ“‡å·²å­˜çš„é‡‘é‘° --</option>';
            for(let name in saved) {
                const opt = document.createElement('option');
                opt.value = saved[name];
                opt.text = name;
                select.appendChild(opt);
            }
        }

        function saveKey() {
            const key = document.getElementById('apiKey').value.trim();
            const name = document.getElementById('keyName').value.trim();
            if(!key || !name) return alert('è«‹è¼¸å…¥ Key å’Œåç¨±');
            const saved = JSON.parse(localStorage.getItem('v14_api_keys') || '{}');
            saved[name] = key;
            localStorage.setItem('v14_api_keys', JSON.stringify(saved));
            refreshKeyList();
            alert(`å·²å„²å­˜: ${name}`);
        }

        function loadSelectedKey() {
            const key = document.getElementById('savedKeys').value;
            if(key) document.getElementById('apiKey').value = key;
        }

        function deleteKey() {
            const select = document.getElementById('savedKeys');
            const name = select.options[select.selectedIndex].text;
            if(!select.value) return;
            if(confirm(`ç¢ºå®šåˆªé™¤ ${name} å—ï¼Ÿ`)) {
                const saved = JSON.parse(localStorage.getItem('v14_api_keys') || '{}');
                delete saved[name];
                localStorage.setItem('v14_api_keys', JSON.stringify(saved));
                refreshKeyList();
                document.getElementById('apiKey').value = '';
            }
        }

        async function scanModels() {
            const key = document.getElementById('apiKey').value.trim();
            if(!key) return alert('è«‹è¼¸å…¥ Key');
            const select = document.getElementById('apiModel');
            select.innerHTML = '<option>æƒæä¸­...</option>';
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await res.json();
                select.innerHTML = '';
                if(data.models) {
                    data.models.filter(m => m.supportedGenerationMethods.includes("generateContent")).forEach(m => {
                        const name = m.name.replace('models/', '');
                        select.add(new Option(name, name));
                    });
                    document.getElementById('statusDot').className = 'status-dot status-ok';
                    document.getElementById('statusMsg').innerHTML = '<span class="status-dot status-ok"></span> æ¨¡å‹å·²å°±ç·’';
                } else { throw new Error("No models"); }
            } catch (e) { alert('æƒæå¤±æ•—'); select.innerHTML = '<option value="">æƒæå¤±æ•—</option>'; }
        }

        // --- Lighting & Theme Logic ---
        function populateLightingOptions() {
            const sel = document.getElementById('pLight');
            sel.innerHTML = '<option value="">-- æœªæŒ‡å®š --</option>';
            for (const key in LIGHTING_DATA) {
                const opt = document.createElement('option');
                opt.value = key; opt.text = LIGHTING_DATA[key].name; sel.appendChild(opt);
            }
        }

        function updateLightPanel() {
            const key = document.getElementById('pLight').value;
            const panel = document.getElementById('lightPanel');
            panel.style.display = key ? 'block' : 'none';
            if(!key) return;
            const cfg = LIGHTING_DATA[key];
            
            const angleInput = document.getElementById('lAngle');
            const widthInput = document.getElementById('lWidth');
            const contrastSel = document.getElementById('lContrast');
            const targetSel = document.getElementById('lTarget');

            // Angle & Width
            if (cfg.default_angle === null && cfg.default_width === null) {
                angleInput.value = ''; widthInput.value = '';
                angleInput.placeholder = 'â€” ä¸é©ç”¨ â€”'; widthInput.placeholder = 'â€” ä¸é©ç”¨ â€”';
                angleInput.disabled = true; widthInput.disabled = true;
            } else {
                angleInput.disabled = false; widthInput.disabled = false;
                angleInput.placeholder = ''; widthInput.placeholder = '';
                angleInput.value = cfg.default_angle;
                widthInput.value = cfg.default_width;
            }

            // Contrast
            const contrastOptions = [
                { v: "2:1", label: "2:1ï¼ˆæŸ”å’Œï¼‰" }, { v: "5:1", label: "5:1ï¼ˆé«˜åå·®ï¼‰" },
                { v: "6:1", label: "6:1ï¼ˆç¡¬å…‰ï¼‰" }, { v: "7:1", label: "7:1ï¼ˆæ¥µé«˜ï¼‰" },
                { v: "8:1", label: "8:1ï¼ˆèƒŒå…‰ï¼‰" }, { v: "9:1", label: "9:1ï¼ˆæ¥µç¡¬ï¼‰" }
            ];
            contrastSel.innerHTML = '';
            contrastOptions.forEach(c => contrastSel.add(new Option(c.label, c.v)));
            
            if (cfg.contrast_ratio) {
                contrastSel.value = cfg.contrast_ratio;
                contrastSel.disabled = false;
            } else {
                contrastSel.value = '';
                contrastSel.disabled = true;
            }

            // Target
            const opts = Array.from(targetSel.options).map(o => o.value);
            if (opts.includes(cfg.default_target)) {
                targetSel.value = cfg.default_target;
            } else {
                targetSel.value = 'Unspecified';
            }
        }

        function updateThemePanel() {
            const val = document.getElementById('pTheme').value;
            const panel = document.getElementById('themePanel');
            panel.style.display = val ? 'block' : 'none';
            if(THEME_DATA[val]) {
                const d = THEME_DATA[val];
                document.getElementById('tHighlight').value = d.h;
                document.getElementById('tShadow').value = d.s;
                document.getElementById('tAccent').value = d.a;
                document.getElementById('tTone').value = d.t;
                ['h','s','a'].forEach(syncSwatch);
            }
        }

        function syncSwatch(type) {
            const hex = document.getElementById('t' + (type==='h'?'Highlight':type==='s'?'Shadow':'Accent')).value;
            if(/^#[0-9A-F]{6}$/i.test(hex)) document.getElementById('swatch-'+type).style.backgroundColor = hex;
        }

        // --- Dynamic Lists ---
        function addRef(id="", type="Auxiliary", weight=0.8, age="N/A", note="") {
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `
                <button class="btn-remove" onclick="this.parentElement.remove()">âœ•</button>
                <div class="row">
                    <div class="col"><label>åƒè€ƒ ID</label><input type="text" class="r-id" value="${id}"></div>
                    <div class="col"><label>é¡å‹</label><select class="r-type">
                        <option value="Main Identity" ${type==="Main Identity"?'selected':''}>ä¸»èº«åˆ†</option>
                        <option value="Style/Hair" ${type==="Style/Hair"?'selected':''}>é«®å‹/é¢¨æ ¼</option>
                        <option value="Expression" ${type==="Expression"?'selected':''}>è¡¨æƒ…åƒè€ƒ</option>
                        <option value="Auxiliary" ${type==="Auxiliary"?'selected':''}>è¼”åŠ©ç‰©ä»¶</option>
                    </select></div>
                    <div class="col"><label>æ¬Šé‡</label><input type="number" class="r-weight" value="${weight}" step="0.1"></div>
                    <div class="col"><label>å¹´é½¡</label><input type="text" class="r-age" value="${age}"></div>
                </div>
                <input type="text" class="r-note" placeholder="å‚™è¨»..." value="${note}">
            `;
            document.getElementById('refList').appendChild(div);
        }

        function checkCloseup() { 
            const val = document.getElementById('pShot').value || '';
            const isClose = val.toLowerCase().includes('close-up');
            document.getElementById('closeupBox').style.display = isClose ? 'block' : 'none';
        }

        // --- Edit Mode Logic ---
        function toggleBgPreset() {
            const enabled = document.getElementById('useBgPreset').checked;
            document.getElementById('bgRefId').disabled = !enabled;
            document.getElementById('bgLightOpt').disabled = !enabled;
        }

        function addModItem(key="", val="") { 
            addModItemToDiv('modList', key, val, "ä¾‹å¦‚: skin_texture", "ä¾‹å¦‚: Remove wrinkles around eyes...");
        }

        function addSpatialItem(key="", val="") { 
            addModItemToDiv('spatialList', key, val, "ä¾‹å¦‚: depth_of_field", "ä¾‹å¦‚: Background should be blurred...");
        }

        function addModItemToDiv(targetId, key="", val="", phKey="", phVal="") {
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `
                <button class="btn-remove" onclick="this.parentElement.remove()">âœ•</button>
                <div class="row">
                    <div class="col" style="flex:1;"><input type="text" class="${targetId === 'modList' ? 'm-key' : 's-key'}" placeholder="${phKey}" value="${key}"></div>
                    <div class="col" style="flex:3;"><textarea class="${targetId === 'modList' ? 'm-val' : 's-val'}" style="height:60px;" placeholder="${phVal}">${val}</textarea></div>
                </div>
            `;
            document.getElementById(targetId).appendChild(div);
        }

        // --- Data Gathering ---
        function getGenData() {
            const refs = Array.from(document.querySelectorAll('#refList .dynamic-item')).map(i => ({
                id: i.querySelector('.r-id').value,
                type: i.querySelector('.r-type').value,
                weight: i.querySelector('.r-weight').value,
                age: i.querySelector('.r-age').value,
                note: i.querySelector('.r-note').value
            }));
            
            const effects = Array.from(document.querySelectorAll('.effect-check:checked')).map(c => c.value);
            if(!effects.includes("8K Resolution")) effects.push("8K Resolution");

            let closeupTarget = document.getElementById('pCloseupOther').value;
            if (closeupTarget === 'Custom') closeupTarget = document.getElementById('customFocus').value;

            return {
                project: document.getElementById('pName').value,
                photogenic_mode: document.getElementById('isPhotogenic').checked,
                subject: document.getElementById('pSubject').value,
                context: document.getElementById('pContext').value,
                parameters: {
                    style: document.getElementById('pStyle').value,
                    shot_scale_lens: document.getElementById('pShot').value,
                    closeup_focus: closeupTarget,
                    angle: document.getElementById('pAngle').value,
                    lighting: {
                        preset: document.getElementById('pLight').value,
                        angle: document.getElementById('lAngle').value,
                        width: document.getElementById('lWidth').value,
                        contrast: document.getElementById('lContrast').value,
                        target: document.getElementById('lTarget').value
                    },
                    theme_color: {
                        preset: document.getElementById('pTheme').value,
                        highlight: document.getElementById('tHighlight').value,
                        shadow: document.getElementById('tShadow').value,
                        accent: document.getElementById('tAccent').value,
                        tone: document.getElementById('tTone').value
                    },
                    // Added Expression & Mood (V1418)
                    expression: document.getElementById('pExpression').value,
                    mood_atmosphere: document.getElementById('pMood').value,
                    special_effects: effects
                },
                reference_matrix: refs,
                negative: document.getElementById('pNeg').value
            };
        }

        function getEditData() {
            const mods = {};
            document.querySelectorAll('#modList .dynamic-item').forEach(i => {
                const k = i.querySelector('.m-key').value.trim();
                if(k) mods[k] = i.querySelector('.m-val').value;
            });
            const spatial = {};
            document.querySelectorAll('#spatialList .dynamic-item').forEach(i => {
                const k = i.querySelector('.s-key').value.trim();
                if(k) spatial[k] = i.querySelector('.s-val').value;
            });
            
            if (document.getElementById('useBgPreset').checked) {
                const refId = document.getElementById('bgRefId').value || "[REFERENCE_ID]";
                const lightingOpt = document.getElementById('bgLightOpt').value;
                mods["subject_preservation"] = "Keep facial identity, expression, pose, and clothing exactly as is.";
                mods["scene_reconstruction"] = `Replace background entirely using ${refId} as reference.`;
                spatial["depth_separation"] = "Apply shallow depth of field (f/2.8) to blur background while keeping subject sharp.";
                if (lightingOpt.includes("Keep Original")) {
                    spatial["lighting_harmonization"] = "Apply minor adjustments to harmonize, but maintain original subject lighting direction.";
                } else {
                    spatial["lighting_harmonization"] = `Adjust subject's shadows and color temperature to fully match the ${refId} environment.`;
                }
            }

            const negs = document.getElementById('eNeg').value.split(/,|\n/).map(s => s.trim()).filter(s => s);
            let instruction = document.getElementById('eInstruction').value;
            if(document.getElementById('useBgPreset').checked && !instruction) {
                const refId = document.getElementById('bgRefId').value || "[REFERENCE_ID]";
                instruction = `Recreate the primary image by replacing the background entirely with ${refId}, while STRICTLY preserving the subject's identity.`;
            }

            return {
                project: document.getElementById('eName').value,
                instruction: instruction,
                modifications: mods,
                spatial_logic: spatial,
                negative_prompt: negs
            };
        }

        function generateLocal() { 
            const data = currentTab === 'gen' ? getGenData() : getEditData();
            document.getElementById('output').textContent = JSON.stringify(data, null, 2);
        }

        // --- Execution ---
        async function runAI() {
            const key = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('apiModel').value;
            if(!model) return alert('è«‹å…ˆæƒææ¨¡å‹');
            document.getElementById('output').textContent = "è½‰è­¯ä¸­...";
            
            let prompt = "";
            let inputData = {};
            
            if (currentTab === 'gen') {
                inputData = getGenData();
                prompt = `You are a master photography prompt engineer. Translate inputs to pro English. 
                Focus heavily on the 'lighting' object details (angle, width, contrast ratio) and 'theme_color' hex codes.
                Input JSON: ${JSON.stringify(inputData)}.
                Output ONLY valid JSON structure matching input but enriched.`;
            } else {
                inputData = getEditData();
                prompt = `You are an AI image editing specialist. Transform the user input into a strict JSON format for image modification.
                Rules: 1. Expand 'modifications' and 'spatial_logic' values into highly detailed, technical photography instructions.
                2. Keep the output JSON structure identical to the input. Input Data: ${JSON.stringify(inputData)}`;
            }

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({contents: [{parts: [{text: prompt}]}]})
                });
                const data = await res.json();
                let text = data.candidates[0].content.parts[0].text;
                document.getElementById('output').textContent = text.replace(/```json|```/gi, '').trim();
            } catch (e) { document.getElementById('output').textContent = "é€£ç·šå¤±æ•—: " + e; }
        }

        function saveFile() {
            const blob = new Blob([document.getElementById('output').textContent], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const fileName = currentTab === 'gen' ? document.getElementById('pName').value : document.getElementById('eName').value;
            a.download = fileName + '.json';
            a.click();
        }

        function loadFile(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const json = JSON.parse(event.target.result);
                    document.getElementById('output').textContent = JSON.stringify(json, null, 2);
                    alert('æª”æ¡ˆå·²è®€å–è‡³é è¦½è¦–çª— (UIå›å¡«åƒ…æ”¯æ´éƒ¨åˆ†æ¬„ä½)');
                } catch(ex) { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
            };
            reader.readAsText(e.target.files[0]);
        }
        function copyText() { navigator.clipboard.writeText(document.getElementById('output').textContent); alert('å·²è¤‡è£½'); }
    </script>
</body>
</html>